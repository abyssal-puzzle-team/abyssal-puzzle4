<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>深渊迷宫 - Meta谜题</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e);
            color: #ffffff;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* 时间血条 */
        .time-bar-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            height: 30px;
            z-index: 1000;
        }

        .time-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #333, #555);
            border: 2px solid #00ffff;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
            transform: skew(-10deg);
        }

        .time-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #ff6600, #ffff00, #00ff00);
            transition: width 1s ease-in-out;
            width: 100%;
        }

        .time-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) skew(10deg);
            font-weight: bold;
            color: #ffffff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            font-size: 14px;
        }

        /* 主容器 */
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding-top: 70px;
        }

        /* 迷宫区域 */
        .maze-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            min-height: 60vh;
        }

        .maze-grid {
            display: grid;
            grid-template-columns: repeat(16, 40px);
            grid-template-rows: repeat(6, 40px);
            gap: 2px;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #00ffff;
        }

        .maze-cell {
            width: 40px;
            height: 40px;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .maze-cell:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        /* 不同类型的格子样式 */
        .cell-wall { background: #444; color: #666; cursor: not-allowed; }
        .cell-empty { background: #222; color: #aaa; }
        .cell-start { background: #00ff00; color: #000; font-weight: bold; }
        .cell-key { background: #ffff00; color: #000; }
        .cell-door { background: #8b4513; color: #fff; }
        .cell-trap { background: #ff0000; color: #fff; }
        .cell-power { background: #0080ff; color: #fff; }
        .cell-card { background: #ff00ff; color: #fff; }
        .cell-elevator { background: #00ffff; color: #000; }
        .cell-player { background: #00ff00; border: 3px solid #fff; animation: pulse 1s infinite; }
        .cell-visible { opacity: 1; }
        .cell-hidden { opacity: 0.3; background: #111; }
        .cell-unlocked { background: #666; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* 信息面板 */
        .info-panel {
            height: 300px;
            display: flex;
            background: rgba(0, 0, 0, 0.8);
            border-top: 2px solid #00ffff;
        }

        .status-panel, .clues-panel {
            flex: 1;
            padding: 20px;
            border-right: 1px solid #333;
        }

        .clues-panel {
            border-right: none;
        }

        .panel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #00ffff;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .status-item {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-label {
            color: #ccc;
        }

        .status-value {
            color: #00ff00;
            font-weight: bold;
        }

        .clue-item {
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(0, 255, 255, 0.1);
            border-left: 3px solid #00ffff;
            border-radius: 3px;
            font-size: 14px;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            margin: 10% auto;
            padding: 30px;
            border: 2px solid #00ffff;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            color: #fff;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 10px;
        }

        .close:hover {
            color: #fff;
        }

        /* 谜题输入框 */
        .puzzle-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #00ffff;
            border-radius: 5px;
            color: #fff;
            font-size: 16px;
        }

        .puzzle-input:focus {
            outline: none;
            border-color: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }

        /* 按钮样式 */
        .btn {
            background: linear-gradient(45deg, #00ffff, #0080ff);
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.3);
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 4x4谜题输入区域 */
        .puzzle-4x4 {
            display: none;
            margin-top: 20px;
        }

        .puzzle-4x4-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .puzzle-4x4-input {
            padding: 10px;
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #00ffff;
            border-radius: 5px;
            color: #fff;
            font-size: 16px;
        }

        /* 逃生按钮 */
        .escape-btn {
            background: linear-gradient(45deg, #ff0000, #ff6600);
            color: #fff;
            font-size: 18px;
            padding: 15px 30px;
            margin-top: 20px;
        }

        /* 冷却提示 */
        .cooldown-notice {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff0000;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
            color: #ff6666;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .maze-grid {
                grid-template-columns: repeat(16, 25px);
                grid-template-rows: repeat(6, 25px);
            }
            
            .maze-cell {
                width: 25px;
                height: 25px;
                font-size: 10px;
            }
            
            .info-panel {
                flex-direction: column;
                height: auto;
            }
            
            .time-bar-container {
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <!-- 时间血条 -->
    <div class="time-bar-container">
        <div class="time-bar">
            <div class="time-bar-fill" id="timeBarFill"></div>
            <div class="time-text" id="timeText">剩余时间: --:--</div>
        </div>
    </div>

    <!-- 主容器 -->
    <div class="main-container">
        <!-- 迷宫区域 -->
        <div class="maze-container">
            <div class="maze-grid" id="mazeGrid">
                <!-- 迷宫格子将通过JavaScript动态生成 -->
            </div>
        </div>

        <!-- 信息面板 -->
        <div class="info-panel">
            <!-- 状态面板 -->
            <div class="status-panel" id="statusPanel">
                <div class="panel-title">状态信息</div>
                <div class="status-item">
                    <span class="status-label">当前位置:</span>
                    <span class="status-value" id="playerPosition">[0,0]</span>
                </div>
                <div class="status-item">
                    <span class="status-label">钥匙数量:</span>
                    <span class="status-value" id="keyCount">0</span>
                </div>
                <div class="status-item">
                    <span class="status-label">电力装置:</span>
                    <span class="status-value" id="powerCount">0/3</span>
                </div>
                <div class="status-item">
                    <span class="status-label">门禁卡:</span>
                    <span class="status-value" id="cardStatus">未获得</span>
                </div>
                <div class="status-item">
                    <span class="status-label">剩余时间:</span>
                    <span class="status-value" id="timeRemaining">--:--</span>
                </div>
            </div>

            <!-- 线索面板 -->
            <div class="clues-panel" id="cluesPanel">
                <div class="panel-title">已获得线索</div>
                <div id="cluesList">
                    <div style="color: #666; font-style: italic;">暂无线索</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 小谜题模态框 -->
    <div id="puzzleModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePuzzleModal()">&times;</span>
            <h2>解决谜题以继续前进</h2>
            <div id="puzzleContent">
                <p id="puzzleQuestion">正在加载谜题...</p>
                <input type="text" id="puzzleAnswer" class="puzzle-input" placeholder="请输入答案">
                <div id="cooldownNotice" class="cooldown-notice" style="display: none;">
                    <p>答案错误！请等待 <span id="cooldownTime">0</span> 秒后重试</p>
                </div>
                <button class="btn" onclick="submitPuzzleAnswer()">提交答案</button>
                <button class="btn" onclick="skipPuzzle()" style="background: linear-gradient(45deg, #ff6600, #ff0000); color: #fff;">跳过谜题 (扣除时间)</button>
            </div>
        </div>
    </div>

    <!-- 4x4谜题模态框 -->
    <div id="puzzle4x4Modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="close4x4Modal()">&times;</span>
            <h2>逃生谜题 - 4x4逻辑推理</h2>
            <div id="puzzle4x4Content">
                <p>请根据线索填入正确的数字排列：</p>
                <p style="color: #ffff00; margin: 10px 0;">格式：每行输入4个数字，用空格分隔</p>
                
                <div class="puzzle-4x4-grid">
                    <input type="text" class="puzzle-4x4-input" id="row1" placeholder="1 2 3 4">
                    <input type="text" class="puzzle-4x4-input" id="row2" placeholder="4 3 2 1">
                    <input type="text" class="puzzle-4x4-input" id="row3" placeholder="2 5 1 4">
                    <input type="text" class="puzzle-4x4-input" id="row4" placeholder="1 2 3 4">
                </div>
                
                <div id="puzzle4x4Cooldown" class="cooldown-notice" style="display: none;">
                    <p>答案错误！请等待 <span id="puzzle4x4CooldownTime">0</span> 秒后重试</p>
                </div>
                
                <button class="btn" onclick="submit4x4Answer()">提交答案</button>
                <button class="btn escape-btn" onclick="attemptEscape()" id="escapeBtn">逃生</button>
            </div>
        </div>
    </div>

    <script>
        // 游戏状态
        let gameState = {
            playerX: 0,
            playerY: 0,
            keys: 0,
            powerDevices: 0,
            hasCard: false,
            unlockedCells: new Set(['0,0']), // 已解锁的格子
            clues: [],
            username: '',
            password: '',
            metaTimeRemaining: 0,
            puzzle4x4Solved: false,
            solvedTraps: new Set() // 已解决的陷阱
        };

        // 迷宫地图定义 (6x16)
        const mazeMap = [
            // y=0 (底行)
            ['start', 'empty', 'wall', 'wall', 'empty', 'empty', 'empty', 'empty', 'wall', 'card', 'wall', 'wall', 'key', 'wall', 'wall', 'power'],
            // y=1
            ['empty', 'empty', 'empty', 'empty', 'empty', 'wall', 'key', 'empty', 'empty', 'empty', 'wall', 'empty', 'empty', 'door', 'empty', 'trap'],
            // y=2
            ['empty', 'wall', 'empty', 'wall', 'empty', 'wall', 'wall', 'empty', 'wall', 'empty', 'door', 'empty', 'empty', 'wall', 'elevator', 'empty'],
            // y=3
            ['empty', 'empty', 'empty', 'wall', 'empty', 'empty', 'wall', 'empty', 'wall', 'empty', 'wall', 'empty', 'empty', 'empty', 'wall', 'empty'],
            // y=4
            ['wall', 'wall', 'empty', 'wall', 'empty', 'door', 'empty', 'empty', 'door', 'empty', 'wall', 'empty', 'wall', 'trap', 'empty', 'empty'],
            // y=5 (顶行)
            ['wall', 'power', 'trap', 'wall', 'key', 'wall', 'empty', 'wall', 'door', 'empty', 'empty', 'empty', 'door', 'empty', 'power', 'wall']
        ];

        // 线索列表
        const allClues = [
            
