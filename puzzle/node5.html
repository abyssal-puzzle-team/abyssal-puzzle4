<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>观察者终端 - Node 5</title>
    <style>
        :root {
            --terminal-bg: rgba(0, 15, 5, 0.4);
            --text-color: #00ff41;
            --glow-color: rgba(0, 255, 65, 0.75);
            --error-color: #ff4141;
            --error-glow: rgba(255, 65, 65, 0.75);
            --info-color: #00bfff;
            --info-glow: rgba(0, 191, 255, 0.5);
            --font-mono: 'Consolas', 'Menlo', 'Microsoft YaHei', 'Courier New', monospace, sans-serif;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            /* MODIFICATION: Body is now transparent to reveal the background container */
            background-color: transparent;
            color: var(--text-color);
            font-family: var(--font-mono);
            overflow: hidden;
        }

        /* NEW: Container for the stars and the black background */
        #background-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: #000;
            z-index: -1; /* Places it at the very back */
        }
        
        .fullscreen-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
        }
        
        #frameless-logs-container {
            flex-direction: column; z-index: 60;
            display: none; opacity: 0;
            filter: blur(0px); 
        }
        
        #preloader {
            background: #000; z-index: 100;
        }
        #preloader-text { font-size: 1.5em; text-shadow: 0 0 8px var(--glow-color); }
        @keyframes blink { 50% { opacity: 0; } }
        .blinking-cursor { animation: blink 1s step-end infinite; }

        #loading-screen {
            background: #000; z-index: 50;
            display: none; opacity: 0;
            flex-direction: column; gap: 20px;
        }
        
        #css-loader {
            position: relative; width: 120px; height: 120px;
        }
        .arc {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            border: 3px solid transparent;
            border-top-color: var(--info-color);
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            box-sizing: border-box;
        }
        .arc:nth-child(2) { border-color: transparent; border-bottom-color: var(--error-color); animation-direction: reverse; animation-duration: 1.2s; }
        .arc:nth-child(3) { width: 70%; height: 70%; top: 15%; left: 15%; animation-duration: 2s; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* MODIFICATION: Star layers are now absolutely positioned inside their container */
        .star-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #star-background { width: 200%; height: 200%; background-image: radial-gradient(1px, white, rgba(255, 255, 255, 0)), radial-gradient(1.5px, rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0)), radial-gradient(2px, rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0)); background-repeat: repeat; background-size: 600px 600px, 400px 400px, 200px 200px; background-position: 0 0, 100px 150px, 250px 370px; animation: move-stars 200s linear infinite; }
        #twinkling-stars { background: transparent; background-image: radial-gradient(white 1px, transparent 0); background-size: 100px 100px; animation: twinkle 10s ease-in-out infinite; }
        @keyframes move-stars { from { transform: translate(0, 0); } to { transform: translate(-50%, -50%); } }
        @keyframes twinkle { 0%, 100% { opacity: 0.2; } 50% { opacity: 0.8; } }

        #terminal {
            width: 95%; height: 95%; max-width: 1400px; max-height: 900px;
            border: 2px solid var(--info-color); border-radius: 10px;
            box-shadow: 0 0 20px var(--info-glow), inset 0 0 15px rgba(0, 191, 255, 0.15);
            /* This is the key: a semi-transparent background combined with a backdrop-filter */
            background: var(--terminal-bg); 
            backdrop-filter: blur(3px);
            display: none; flex-direction: column;
            padding: 20px; box-sizing: border-box; opacity: 0;
            position: relative; z-index: 10;
        }

        #output-container { flex-grow: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--text-color) var(--terminal-bg); }
        .log-line { opacity: 0; white-space: pre-wrap; word-break: break-all; text-shadow: 0 0 5px var(--glow-color); margin-bottom: 8px; font-size: 1em; }
        #node-image { display: none; max-width: 80%; max-height: 40vh; border: 2px solid var(--info-color); box-shadow: 0 0 15px var(--info-glow); margin: 20px auto; opacity: 0; }
        .log-line.error { color: var(--error-color); text-shadow: 0 0 7px var(--error-glow); }
        .log-line.success { color: var(--text-color); text-shadow: 0 0 7px var(--glow-color); }
        .log-line.info { color: var(--info-color); text-shadow: 0 0 7px var(--info-glow); }
        .log-line.system { font-style: italic; color: #ccc; }
        #input-area { display: flex; align-items: center; margin-top: 20px; visibility: hidden; }
        #input-area span { margin-right: 10px; text-shadow: 0 0 5px var(--glow-color); }
        #key-input { flex-grow: 1; background: transparent; border: none; border-bottom: 1px solid var(--text-color); color: var(--text-color); font-family: inherit; font-size: 1em; padding: 5px; outline: none; }
        #key-input:focus { border-bottom-width: 2px; box-shadow: 0 5px 10px -5px var(--glow-color); }
        #key-input:disabled { background-color: rgba(128, 128, 128, 0.2); }
        #response-message { margin-top: 10px; min-height: 1.2em; font-weight: bold; }
        @keyframes shake { 0%, 100% { transform: translate(0, 0); } 10%, 30%, 50%, 70%, 90% { transform: translate(-2px, 2px); } 20%, 40%, 60%, 80% { transform: translate(2px, -2px); } }
        .shake { animation: shake 0.3s ease-in-out; }
        
        .bordered-log {
            padding: 15px 25px;
            border: 2px solid;
            border-radius: 5px;
            display: inline-block;
            text-align: center;
            opacity: 0;
            border-color: var(--info-color);
            box-shadow: 0 0 15px var(--info-glow);
        }
        .bordered-log.error {
            border-color: var(--error-color);
            box-shadow: 0 0 15px var(--error-glow);
        }
        .bordered-log.success {
            border-color: var(--text-color);
            box-shadow: 0 0 15px var(--glow-color);
        }
    </style>
</head>
<body>
    <!-- MODIFICATION: Star layers wrapped in a container that provides the black background -->
    <div id="background-container">
        <div class="star-layer" id="star-background"></div>
        <div class="star-layer" id="twinkling-stars"></div>
    </div>
    
    <div class="fullscreen-container" id="preloader"><div id="preloader-text">OBSERVER_OS BOOTING...<span class="blinking-cursor">_</span></div></div>
    <div class="fullscreen-container" id="frameless-logs-container"></div>
    <div class="fullscreen-container" id="loading-screen">
        <div id="css-loader"><div class="arc"></div><div class="arc"></div><div class="arc"></div></div>
        <div class="log-line info" style="opacity:1;">[SYNCHRONIZING VISUAL FEED...]</div>
    </div>

    <div id="terminal">
        <div id="output-container"></div>
        <div><div id="response-message"></div><div id="input-area"><span>[NODE5_KEY]></span><input type="text" id="key-input" autocomplete="off" spellcheck="false" autofocus disabled></div></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 元素获取 ---
            const preloader = document.getElementById('preloader');
            const framelessLogsContainer = document.getElementById('frameless-logs-container');
            const loadingScreen = document.getElementById('loading-screen');
            const terminal = document.getElementById('terminal');
            const outputContainer = document.getElementById('output-container');
            const keyInput = document.getElementById('key-input');
            const inputArea = document.getElementById('input-area');
            const bodyEl = document.body;
            
            // --- API & 工具函数 ---
            const API_BASE_URL = 'http://111.170.11.168:15114/proxy/3000';
            const NODE_ID = 'node5';
            const delay = ms => new Promise(res => setTimeout(res, ms));
            let isCooldown = false;
            
            function addLog(text, classes = [], parent = outputContainer) {
                const p = document.createElement('p');
                p.textContent = text;
                const finalClasses = ['log-line', ...classes.filter(c => c !== 'log-line')];
                p.classList.add(...finalClasses);
                parent.appendChild(p);
                if (parent.id === 'output-container') {
                    parent.scrollTop = parent.scrollHeight;
                }
                return p;
            }
            async function typeText(element, text, speed = 50) {
                element.style.opacity = 1;
                for (let i = 0; i < text.length; i++) {
                    element.textContent += text[i];
                    if (outputContainer) outputContainer.scrollTop = outputContainer.scrollHeight;
                    await delay(speed);
                }
            }
            async function backspaceText(element, speed = 35) {
                const text = element.textContent;
                for (let i = text.length; i > 0; i--) {
                    element.textContent = element.textContent.slice(0, -1);
                    await delay(speed);
                }
            }

            // --- 主叙事流程 (在终端内) ---
            async function playMainNarrative() {
                terminal.style.display = 'flex';
                await anime({ targets: terminal, opacity: 1, duration: 1500, easing: 'easeInOutQuad' }).finished;

                const image = document.createElement('img');
                image.id = 'node-image';
                image.src = './img/node5.jpeg';
                image.alt = '宇宙异常现象';
                outputContainer.appendChild(image);
                image.style.display = 'block';
                await anime({ targets: image, opacity: [0, 1], duration: 2000 }).finished;
                await delay(1000);

                const p1 = addLog('', []); await typeText(p1, '995号观察者队长: 总部！听的到吗？～我们此次行动部队的部分队员观星舱窗出了些问题，这是他们现在对舱窗向外拍的截图，我眼前看到的也是这个样子，但总有队员反映这是异常现象......', 25);
                await delay(1000);
                const p2 = addLog('', []); await typeText(p2, '观察者总部: 收到，看上去是宇宙中漂浮的巨物，应该没什么危害性，可以派几个队员打开气闸先去测量一下这种红色物质的成分，说不定可以发现生命甚至文明......', 25);
                await delay(1000);
                const p3 = addLog('', []); await typeText(p3, '995号观察者队长: 是！我也该活动活动手脚了，除了队员，我也要亲自上场......', 25);
                await delay(500);
                const p4 = addLog('', ['system']); await typeText(p4, '[气闸打开......]', 50);
                await delay(1000);
                const p5 = addLog('', ['info']); await typeText(p5, '<如果照片中的红色代表着低温，那么......>', 50);
                await delay(1500);
                const p6 = addLog('', []);
                await typeText(p6, '995号观察者队长: 不对！可是......可是......', 80);
                await delay(1000);
                await backspaceText(p6);
                p6.textContent = '';
                p6.style.filter = 'blur(5px)';
                await typeText(p6, '金白光的前一秒上刻着:@-$％……是！％...￥＆是！口口口', 60);
                await anime({ targets: p6, filter: ['blur(5px)', 'blur(0px)'], duration: 1000, easing: 'easeOutQuad' }).finished;
                await delay(1500);
                const p7 = addLog('', []);
                await typeText(p7, '观察者总部: 知道你遵命了，干嘛说这么多遍"是"呢？快行动吧，毕竟......', 30);
                terminal.style.background = 'white';
                await delay(50);
                terminal.style.background = 'var(--terminal-bg)';
                await delay(50);
                p7.textContent = p7.textContent.slice(0, -6);
                const p8 = addLog('<NO EXISTING CONNECTION>', ['error']);
                anime({ targets: p8, opacity: [0, 1], duration: 200, easing: 'steps(2)' });
                await delay(1000);
                const p9 = addLog('不知为何信号突然中断了，紧接着，留给总部的只有满屏幕的乱码，根本找不出任何逻辑:', ['system']);
                anime({ targets: p9, opacity: [0, 1], duration: 500 });
                await delay(500);
                const p10 = addLog('', ['error']);
                await typeText(p10, '5Lik5Liq5a2X6IO95qaC5ous5LuA5LmI77yf5oiW6K645piv5pio5pel77yM5Lqm5oiW5piv5LuK5pyd77yM5L2G5pyA5rWq5ryr55qE5LiA5a6a5pivLi4uLi4uCuS/oeWPt+eqgeeEtuS4reaWre+8jOi/h+W8se+8jOi/h+S6jua3t+S5sS4uLi4uLgo8REFUQSBFUlJPUu+8gT4K6YeN5paw5Yqg6L295Lit77yM6K+356iN562JLi4uLi4uCjZZQ2E1YjZBNXB5cTVwMmw1NXFFNUxpQTU0bUg1b0dTNXBpZkxpNHVMaTR1Q2p6bWxiRG1qYTdwbEpub3I2L3Z2SXprdTZQbm9JSG11cEE2WVVoU01HTklUVFpNZVRscFdWZE9jbU50T1haaVdFMTBaREpzY21GVE1XcGlhVFV6WVZkMGNGcEhPVEJNYlU1MllsTTVjMXBZV214aVF6QXhUMVJyUFQ0PQrliqDovb3lpLHotKXvvIHvvIHvvIE......', 5);
                await delay(1000);
                const p11 = addLog('或许只是去完成任务了吧，希望平安回来......', ['system']);
                anime({ targets: p11, opacity: [0, 1], duration: 1000 });
                await delay(1500);

                inputArea.style.visibility = 'visible';
                anime({ targets: inputArea, opacity: [0, 1], duration: 1000 });
                keyInput.disabled = false;
                keyInput.focus();
            }

            // --- API 交互 ---
            async function checkKey(key) {
                if (isCooldown) return;
                setResponseMessage('正在验证密钥...', 'info');
                keyInput.disabled = true;
                try {
                    const response = await fetch(`${API_BASE_URL}/check-key`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nodeId: NODE_ID, key: key }) });
                    const data = await response.json();
                    
                    if (response.ok) {
                        setResponseMessage(data.message, 'success');
                        await delay(1500); 
                        window.location.href = '../storyline/meta_front_sl.html';
                    } else {
                        setResponseMessage(data.message, 'error');
                        if (data.cooldown) {
                            startCooldown(data.cooldown);
                        }
                    }
                } catch (error) {
                    console.error('API Error:', error);
                    setResponseMessage('连接后端服务失败，请检查网络或联系管理员。', 'error');
                } finally {
                    if (!isCooldown && !document.hidden) { 
                        keyInput.disabled = false;
                        keyInput.focus();
                    }
                    keyInput.value = '';
                }
            }

            function setResponseMessage(message, type) { const responseMessage = document.getElementById('response-message'); responseMessage.textContent = message; responseMessage.className = `log-line ${type}`; anime({ targets: responseMessage, opacity: [0, 1], duration: 300 }); }
            function startCooldown(seconds) { isCooldown = true; keyInput.disabled = true; let remaining = seconds; const intervalId = setInterval(() => { remaining--; setResponseMessage(`请求被拒绝，冷却中... ${remaining}s`, 'error'); if (remaining <= 0) { clearInterval(intervalId); isCooldown = false; keyInput.disabled = false; keyInput.focus(); setResponseMessage('可以再次尝试。', 'info'); } }, 1000); }
            async function checkInitialCooldown() { try { const response = await fetch(`${API_BASE_URL}/cooldown-status`); if (response.ok) { const data = await response.json(); if (data.cooldownRemaining > 0) { startCooldown(data.cooldownRemaining); } } } catch (error) { console.warn('无法获取初始冷却状态:', error); } }

            keyInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && keyInput.value.trim() !== '') {
                    checkKey(keyInput.value.trim());
                }
            });

            // --- 启动流程 ---
            async function initialize() {
                // STAGE 1: 系统初始化 (全屏，无边框)
                await delay(2500);
                await anime({ targets: preloader, opacity: 0, duration: 1000 }).finished;
                preloader.style.display = 'none';

                framelessLogsContainer.style.display = 'flex';
                await anime({ targets: framelessLogsContainer, opacity: 1, duration: 500 }).finished;
                
                async function showTransientLog(text, classes, displayTime) {
                    const logElement = addLog(text, ['bordered-log', ...classes], framelessLogsContainer);
                    
                    await anime({ targets: logElement, opacity: 1, duration: 400, easing: 'easeOutQuad' }).finished;
                    await delay(displayTime);
                    await anime({ targets: logElement, opacity: 0, duration: 300, easing: 'easeInQuad' }).finished;

                    logElement.remove();
                }

                await showTransientLog('[Updating Data...]', ['info'], 800);
                await showTransientLog('<HEATED ERROR！>', ['error'], 1000);
                await showTransientLog('[Reconnection Service...]', ['info'], 1200);

                const successLog = addLog('<SUCCEED！！>', ['bordered-log', 'success'], framelessLogsContainer);
                await anime({ targets: successLog, opacity: 1, duration: 500, easing: 'easeOutQuad' }).finished;

                await delay(500); 

                bodyEl.classList.add('shake');
                await anime({ targets: framelessLogsContainer, filter: ['blur(5px)', 'blur(0px)'], duration: 1000, easing: 'easeInOutQuad' }).finished;
                bodyEl.classList.remove('shake');
                
                await delay(300); 

                // STAGE 2: 模块加载
                await anime({ targets: framelessLogsContainer, opacity: 0, duration: 500 }).finished;
                framelessLogsContainer.style.display = 'none';
                framelessLogsContainer.innerHTML = '';
                
                loadingScreen.style.display = 'flex';
                await anime({ targets: loadingScreen, opacity: 1, duration: 1000 }).finished;
                await delay(5000);
                
                await anime({ targets: loadingScreen, opacity: 0, duration: 1000 }).finished;
                loadingScreen.style.display = 'none';
                
                // STAGE 3: 主终端界面
                playMainNarrative();
                checkInitialCooldown();
            }
            
            initialize();
        });
    </script>
</body>
</html>