<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAlSE_META</title>
    <!-- 引入符合主题的字体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;1,400&family=Uncial+Antiqua&display=swap" rel="stylesheet">

    <style>
        /* --- 全局与主题设定 --- */
        :root {
            --parchment-bg: #f5eeda; /* 羊皮纸背景色 */
            --ink-color: #4a2c2a; /* 墨迹颜色 */
            --highlight-color: #a47b36; /* 符号/高光颜色 */
            --error-color: #9d3e3e; /* 错误信息颜色 */
            --success-color: #4a6c4b; /* 成功信息颜色 */
            --font-title: 'Uncial Antiqua', cursive; /* 标题字体 */
            --font-body: 'EB Garamond', serif; /* 正文字体 */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #3d342a;
            background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"%3E%3Cg fill-rule="evenodd"%3E%3Cg fill="%23473b2d" fill-opacity="0.4"%3E%3Cpath opacity=".5" d="M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v--9h-9v9zm10 0h9v-9h-9v9z"/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');
            font-family: var(--font-body);
            color: var(--ink-color);
            display: flex;
            justify-content: center;
            /* MODIFIED: Align to top for long content */
            align-items: flex-start; 
            min-height: 100vh;
            /* MODIFIED: Allow scrolling and add padding */
            overflow-y: auto;
            padding: 5vh 20px;
        }

        /* --- 加载动画 --- */
        #loader-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--parchment-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 1s ease-in-out;
        }

        .loader-symbol {
            font-size: 80px;
            color: var(--highlight-color);
            animation: pulse 2.5s infinite;
            margin-bottom: 20px;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.7;
                text-shadow: 0 0 5px rgba(164, 123, 54, 0.3);
            }
            50% {
                transform: scale(1.1);
                opacity: 1;
                text-shadow: 0 0 15px rgba(164, 123, 54, 0.7);
            }
        }

        .loader-text {
            font-family: var(--font-title);
            font-size: 1.5rem;
            letter-spacing: 2px;
        }

        #loader-status {
            margin-top: 20px;
            font-size: 1rem;
            font-style: italic;
            color: #7a5c4a;
            letter-spacing: 1px;
        }

        /* --- 谜题主容器 --- */
        #puzzle-container {
            width: 90%;
            max-width: 800px; /* MODIFIED: Slightly wider for long text */
            padding: 40px 50px;
            background-color: var(--parchment-bg);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #d4c3a2;
            border-radius: 2px;
            position: relative;
            animation: fadeInScroll 1s ease-out;
            /* MODIFIED: Use flexbox for better internal layout */
            display: flex;
            flex-direction: column;
        }
        
        @keyframes fadeInScroll {
            from { opacity: 0; transform: translateY(30px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        #puzzle-container::before,
        #puzzle-container::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.15), transparent);
            z-index: -1;
        }
        #puzzle-container::before { top: -20px; }
        #puzzle-container::after { bottom: -20px; background: linear-gradient(to top, rgba(0,0,0,0.15), transparent); }

        /* --- 谜题内容样式 --- */
        .title {
            font-family: var(--font-title);
            font-size: 3rem;
            text-align: center;
            color: var(--highlight-color);
            margin-bottom: 25px;
        }

        /* ADDED: Scrollable container for the new puzzle text */
        .puzzle-content {
            width: 100%;
            max-height: 45vh;
            overflow-y: auto;
            background: rgba(0,0,0,0.02);
            border-top: 1px solid rgba(74, 44, 42, 0.2);
            border-bottom: 1px solid rgba(74, 44, 42, 0.2);
            padding: 20px;
            margin-bottom: 30px;
            text-align: left;
            white-space: pre-wrap;
            line-height: 1.7;
            font-size: 1.05rem;
        }
        
        /* ADDED: Custom scrollbar for puzzle content */
        .puzzle-content::-webkit-scrollbar {
            width: 10px;
        }
        .puzzle-content::-webkit-scrollbar-track {
            background: rgba(74, 44, 42, 0.05);
            border-radius: 5px;
        }
        .puzzle-content::-webkit-scrollbar-thumb {
            background-color: rgba(164, 123, 54, 0.4);
            border-radius: 5px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        .puzzle-content::-webkit-scrollbar-thumb:hover {
            background-color: var(--highlight-color);
        }

        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px; /* MODIFIED: Adjusted margin */
        }

        #key-input {
            width: 100%;
            max-width: 400px;
            background-color: transparent;
            border: none;
            border-bottom: 2px solid rgba(74, 44, 42, 0.3);
            color: var(--ink-color);
            padding: 10px 5px;
            font-family: var(--font-body);
            font-style: italic;
            font-size: 1.4rem;
            text-align: center;
            transition: all 0.4s ease;
        }

        #key-input:focus {
            outline: none;
            border-bottom-color: var(--ink-color);
            box-shadow: 0 5px 15px -10px rgba(74, 44, 42, 0.5);
        }

        #key-input::placeholder {
            color: rgba(74, 44, 42, 0.4);
            font-style: italic;
        }
        
        #submit-key {
            margin-top: 30px;
            padding: 10px 30px;
            background-color: transparent;
            border: none;
            color: var(--highlight-color);
            font-family: var(--font-title);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 1px;
            text-shadow: 0 0 8px rgba(164, 123, 54, 0); 
        }
        
        #submit-key:not(:disabled):hover, 
        #submit-key:not(:disabled):focus {
            color: var(--ink-color);
            transform: translateY(-2px);
            text-shadow: 0 0 8px rgba(164, 123, 54, 0.5);
        }
        
        #submit-key:disabled {
            color: #9e8a70;
            cursor: not-allowed;
            transform: none;
            text-shadow: none;
        }

        .message {
            margin-top: 25px;
            min-height: 24px;
            text-align: center;
            font-size: 1rem;
            font-style: italic;
            transition: color 0.5s;
        }

        .message.success { color: var(--success-color); }
        .message.error { color: var(--error-color); }
    </style>
</head>
<body>

    <!-- 加载动画 -->
    <div id="loader-wrapper">
        <div class="loader-symbol">✧</div>
        <p class="loader-text">验证中</p>
        <p id="loader-status"></p>
    </div>

    <!-- 谜题主内容 (默认隐藏) -->
    <main id="puzzle-container" style="display: none;">
        <h1 class="title">False Meta</h1>
        
        <!-- MODIFIED: Puzzle text is now in a scrollable container -->
        <div class="puzzle-content">今日新闻速览:
•第X(被黑笔涂抹)届电子音乐马拉松今日正式开赛!比赛地点为"World of Memories"
•三天后小镇扫墓踏青活动将举办
•各镇镇长共同出席马拉松并致词——"音游健儿展风采,甲辰之年启新篇"
———马拉松决赛专栏———
来自世界各地的选手经过角逐剩余五位选手进行决赛,名单如下:
第X(被黑笔涂抹)届音乐电子马拉松决赛参赛名单
序号 留言 加成🔼 ACC▶️
•? 片側だけの正義,橫切る影に立ち,不自由選び続けてた.
-1.83% 78.18%
•? Under pressure I've been going off the deep end. -3.47% 62.22%
•? Hey yo one for the blood two for the life. 64.2% 149.49%
•? 她并没有留言,同时全曲结束. -9.19% 75.02%
•? 全て壊して. 56.13% 106.35%
———观众留言———
"第X(被黑笔涂抹)届连结成的主题元素是什么呢?"
"听说这次决赛隐藏大奖将会是???新品首秀,到底会是什么呢?好期待啊..."
———现场活动A———
神秘评委即将登场!主题元素搜寻寻找评委身份活动现在开始!
评委当时所在时空区域:①??.1+1-1+1-1…:/②55.6/③2.4
比赛检查点全经过时的计算公式:
...(模糊不清)
cout<<"请输入各个检查点数量";
cin>>①>>②>>③;
…(模糊不清)
int P = 4 * floor(sqrt(①)) + 4 * floor(sqrt(②)) + 2 * floor(sqrt(③)) ;
P--;
...(模糊不清)
———现场活动B———
决赛隐藏大奖"P"谱面创作者藏匿在观众中,第一个找到其"笔名"的观众将会获得神秘礼品!</div>

        <div class="input-group">
            <input type="text" id="key-input" name="key" placeholder="在此输入" autocomplete="off">
            <button id="submit-key">提交</button>
        </div>
        
        <div id="message-area" class="message">
            — 封印静默着，等待着正确的密语与时机。 —
        </div>
    </main>

    <script>
        // ===================================================================
        // ===================    API 接口配置区   =======================
        // ===================================================================
        const API_BASE_URL = 'http://abyssal4.asterveil.top/api'; 
        const API_PATHS = {
            accCheck: '/acc_check_password',
            checkKey: '/check-key',
            setUserData: '/set_user_data'
        };
        
        // ===================================================================
        // ===================      脚本主逻辑      =======================
        // ===================================================================

        document.addEventListener('DOMContentLoaded', () => {

            const loaderWrapper = document.getElementById('loader-wrapper');
            const loaderStatus = document.getElementById('loader-status');
            const puzzleContainer = document.getElementById('puzzle-container');
            const keyInput = document.getElementById('key-input');
            const submitKeyBtn = document.getElementById('submit-key');
            const messageArea = document.getElementById('message-area');
            
            function getApiUrl(pathKey) {
                return `${API_BASE_URL}${API_PATHS[pathKey]}`;
            }

            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
                return null;
            }

            async function handlePageLoad() {
                const username = getCookie('username');
                const password = getCookie('password');

                if (!username || !password) {
                    window.location.href = '../index.html';
                    return;
                }

                loaderStatus.textContent = '正在判断账户进度...';

                try {
                    const response = await fetch(getApiUrl('accCheck'), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: '账户验证失败，请重新登录。' }));
                        alert(errorData.message);
                        window.location.href = '../index.html';
                        return;
                    }
                    
                    const data = await response.json();

                    if (data.success) {
                        const progress = data.user_data.progress;
                        if (progress === '8') { 
                            window.location.href = '../storyline/insight/false_meta.html';
                        } else if (progress === '7') {
                            showPuzzle();
                        } else {
                            window.location.href = '../main.html';
                        }
                    } else {
                        alert(data.message || '账户验证失败，请重新登录。');
                        window.location.href = '../index.html';
                    }
                } catch (error) {
                    console.error('验证API请求失败:', error);
                    loaderStatus.textContent = '错误：与上古服务器的连接中断。';
                    alert('网络异常，无法验证你的身份。请检查浏览器控制台(F12)的错误信息。');
                    setTimeout(() => window.location.href = '../index.html', 3000);
                }
            }

            function showPuzzle() {
                loaderWrapper.style.opacity = '0';
                setTimeout(() => {
                    loaderWrapper.style.display = 'none';
                    puzzleContainer.style.display = 'flex'; // Use flex to match CSS
                }, 1000);
            }
            
            async function handleKeySubmission() {
                const now = new Date();
                const currentSecond = now.getSeconds();
                if (currentSecond !== 8 && currentSecond !== 29) {
                    showMessage('未在数据稳定时输入', 'error');
                    return;
                }

                const key = keyInput.value.trim();
                const username = getCookie('username');
                
                if (!key) {
                    showMessage('不可为空。', 'error');
                    return;
                }
                
                if (!username) {
                    alert('身份印记已模糊，请重新登录。');
                    window.location.href = '../index.html';
                    return;
                }
                
                showMessage('验证中', '');
                submitKeyBtn.disabled = true;

                try {
                    const response = await fetch(getApiUrl('checkKey'), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ nodeId: 'false_meta', key: key })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        showMessage('封印解开！正在记录你的功绩...', 'success');
                        await updateUserProgressAndRedirect(username);
                    } else {
                        const userFriendlyMessage = data.message
                            .replace("密钥错误，已触发冷却。", "密语错误，你感到一阵精神疲劳。")
                            .replace("请求过于频繁，请稍后再试。", "咏唱过于频繁，你需要休息片刻。");
                        
                        if (data.cooldown) {
                            startCooldownTimer(data.cooldown, userFriendlyMessage);
                        } else {
                            showMessage(userFriendlyMessage, 'error');
                            submitKeyBtn.disabled = false;
                        }
                    }

                } catch(error) {
                    console.error('密钥检查API请求失败:', error);
                    showMessage('错误：虚空干扰了你的咏唱。', 'error');
                    submitKeyBtn.disabled = false;
                }
            }

            async function updateUserProgressAndRedirect(username) {
                try {
                    const response = await fetch(getApiUrl('setUserData'), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: username, option: 'progress', value: '8' })
                    });
                    
                    const data = await response.json();

                    if (response.ok && data.success) {
                        showMessage('历史已被铭记，新的篇章即将展开...', 'success');
                        setTimeout(() => {
                            window.location.href = '../storyline/insight/false_meta.html';
                        }, 2000);
                    } else {
                        showMessage(`记录失败: ${data.message}`, 'error');
                        submitKeyBtn.disabled = false;
                    }

                } catch (error) {
                    console.error('设置用户数据API请求失败:', error);
                    showMessage('错误：无法将你的事迹载入史册。', 'error');
                    submitKeyBtn.disabled = false;
                }
            }

            function showMessage(msg, type) {
                messageArea.textContent = `— ${msg} —`;
                messageArea.className = `message ${type}`;
            }

            function startCooldownTimer(seconds, initialMessage) {
                let remaining = seconds;
                keyInput.disabled = true;
                submitKeyBtn.disabled = true;

                const interval = setInterval(() => {
                    if (remaining > 0) {
                        showMessage(`${initialMessage} (${remaining}s)`, 'error');
                        remaining--;
                    } else {
                        clearInterval(interval);
                        showMessage('你可以再次尝试了。', '');
                        submitKeyBtn.disabled = false;
                        keyInput.disabled = false;
                    }
                }, 1000);
            }
            
            submitKeyBtn.addEventListener('click', handleKeySubmission);
            keyInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !submitKeyBtn.disabled) {
                    handleKeySubmission();
                }
            });

            handlePageLoad();
        });
    </script>
</body>
</html>