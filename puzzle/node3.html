<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>谜题节点 3 - 雪的形态</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- 全局与重置 --- */
        :root {
            --bg-light: #f8f9fa;
            --card-bg: #ffffff;
            --primary-text: #212529;
            --secondary-text: #495057;
            --accent-color: #007bff;
            --accent-light: rgba(0, 123, 255, 0.2);
            --error-text: #721c24;
            --error-bg: #f8d7da;
            --success-text: #155724;
            --success-bg: #d4edda;
            --snowflake-color: #ced4da; /* 雪粒子颜色 */
            --border-color: #dee2e6;
            --font-family: 'Noto Serif SC', serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background: var(--bg-light);
            color: var(--primary-text);
            padding: 5vh 20px;
        }
        
        /* --- 加载动画 (全新几何风格) --- */
        #loader-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-light);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.75s ease-out;
            opacity: 1;
            flex-direction: column; /* 为了让文字在加载器下方 */
        }

        #loader-wrapper.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .stylized-loader {
            width: 50px;
            height: 50px;
            position: relative;
            animation: spin 2s linear infinite;
            margin-bottom: 20px; /* 与文字间距 */
        }

        .stylized-loader::before,
        .stylized-loader::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 4px; /* 线条粗细 */
            background-color: var(--accent-color);
            top: 50%;
            left: 0;
            transform-origin: center;
            border-radius: 2px;
        }

        .stylized-loader::before {
            transform: translateY(-50%) rotate(60deg);
        }

        .stylized-loader::after {
            transform: translateY(-50%) rotate(-60deg);
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* --- 落雪背景 (使用简单的圆点) --- */
        .snow-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .snowflake {
            position: absolute;
            top: -5%;
            color: var(--snowflake-color);
            user-select: none;
            animation: fall linear infinite;
            /* 使用 text-shadow 增加柔和感 */
            text-shadow: 0 0 2px var(--snowflake-color);
        }

        /* 随机化雪粒子动画 */
        .snowflake:nth-child(1) { left: 10%; animation-duration: 15s; animation-delay: 0s; font-size: 14px; opacity: 0.8; }
        .snowflake:nth-child(2) { left: 20%; animation-duration: 18s; animation-delay: -3s; font-size: 10px; opacity: 0.6; }
        .snowflake:nth-child(3) { left: 30%; animation-duration: 12s; animation-delay: -5s; font-size: 16px; opacity: 0.9; }
        .snowflake:nth-child(4) { left: 40%; animation-duration: 20s; animation-delay: -1s; font-size: 8px; opacity: 0.5; }
        .snowflake:nth-child(5) { left: 50%; animation-duration: 16s; animation-delay: -7s; font-size: 15px; opacity: 0.8; }
        .snowflake:nth-child(6) { left: 60%; animation-duration: 19s; animation-delay: -2s; font-size: 12px; opacity: 0.7; }
        .snowflake:nth-child(7) { left: 70%; animation-duration: 13s; animation-delay: -4s; font-size: 18px; opacity: 1; }
        .snowflake:nth-child(8) { left: 80%; animation-duration: 22s; animation-delay: -6s; font-size: 9px; opacity: 0.5; }
        .snowflake:nth-child(9) { left: 90%; animation-duration: 17s; animation-delay: -8s; font-size: 16px; opacity: 0.9; }
        .snowflake:nth-child(10) { left: 5%; animation-duration: 25s; animation-delay: -10s; font-size: 11px; opacity: 0.6; }

        @keyframes fall {
            from { transform: translateY(0); }
            to { transform: translateY(105vh); } /* 移除了rotate，因为圆点旋转无意义 */
        }
        
        /* --- 谜题容器及其他样式 (保持不变) --- */
        .puzzle-container {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 40px;
            width: 90%;
            max-width: 650px;
            margin: 0 auto;
            text-align: left;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.08);
            animation: fadeIn 1s ease-out forwards;
            opacity: 0;
            animation-delay: 0.5s;
        }

        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            font-weight: 700;
            color: var(--primary-text);
            text-align: center;
            letter-spacing: 3px;
        }

        .puzzle-text {
            font-size: 1.1rem;
            line-height: 2;
            margin-bottom: 20px;
            color: var(--secondary-text);
            font-weight: 400;
        }
        
        .puzzle-image {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 10px;
            margin: 20px auto;
            display: block;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        #puzzle-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 30px;
        }

        #key-input {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            font-size: 1.1rem;
            color: var(--primary-text);
            font-family: var(--font-family);
            outline: none;
            text-align: center;
            transition: all 0.3s ease;
        }

        #key-input::placeholder { color: #adb5bd; }
        #key-input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px var(--accent-light);
        }
        #key-input.shake { animation: shake 0.5s ease-in-out; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }

        #submit-btn {
            background: var(--accent-color);
            color: #fff;
            border: none;
            border-radius: 8px;
            padding: 15px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: var(--font-family);
            letter-spacing: 5px;
        }

        #submit-btn:hover:not(:disabled) {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
        }
        #submit-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.7;
        }

        #message-area {
            margin-top: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 1rem;
            min-height: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-weight: 700;
            text-align: center;
        }

        #message-area.visible { opacity: 1; }
        #message-area.success {
            background-color: var(--success-bg);
            color: var(--success-text);
            border: 1px solid var(--success-text);
        }
        #message-area.error {
            background-color: var(--error-bg);
            color: var(--error-text);
            border: 1px solid var(--error-text);
        }
    </style>
</head>
<body>

    <!-- 加载动画 -->
    <div id="loader-wrapper">
        <!-- 新的几何加载器 -->
        <div class="stylized-loader"></div>
        <!-- 增加的状态文本 -->
        <p id="loader-status" style="color: var(--secondary-text); font-size: 0.9rem;">正在判断账户进度...</p>
    </div>

    <!-- 落雪背景 -->
    <div class="snow-container">
        <!-- 统一使用圆点作为雪粒子 -->
        <div class="snowflake">•</div>
        <div class="snowflake">•</div>
        <div class="snowflake">•</div>
        <div class="snowflake">•</div>
        <div class="snowflake">•</div>
        <div class="snowflake">•</div>
        <div class="snowflake">•</div>
        <div class="snowflake">•</div>
        <div class="snowflake">•</div>
        <div class="snowflake">•</div>
    </div>

    <!-- 主谜题容器 -->
    <main class="puzzle-container">
        <h1>雪的形态</h1>
        <p class="puzzle-text">
            世人赞我纯白，诗人咏我无瑕。我从云端飘落，以亿万种姿态覆盖大地，却遵循着一个亘古不变的几何法则。我的每一个分身，都是一个微缩的宇宙，拥有六个方向的对称之美。
        </p>
        
        <img src="https://images.unsplash.com/photo-1549491221-f09453a25b8d?q=80&w=1974&auto=format&fit=crop" 
             alt="雪花的微观结构" 
             class="puzzle-image">
        
        <p class="puzzle-text">
            这张显微镜下的照片揭示了我的核心秘密。物理学家开普勒最早在他的著作《六角的雪花》中思考为何我总是如此。这不仅是水的结晶，更是一种数学和自然的和谐共鸣。我的基础形态，这个代表着完美、稳定与和谐的图形，它的英文名即是通往下一阶段的密钥。
        </p>

        <form id="puzzle-form">
            <input type="text" id="key-input" placeholder="在此输入密钥" autocomplete="off">
            <button type="submit" id="submit-btn">提 交</button>
        </form>

        <div id="message-area"></div>
    </main>

    <script>
        // 全局变量，用于在验证后存储用户名，以便后续接口调用
        let currentUsername = '';

        // 帮助函数：从 document.cookie 中获取指定名称的 cookie 值
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const loaderWrapper = document.getElementById('loader-wrapper');
            const loaderStatus = document.getElementById('loader-status');
            const puzzleForm = document.getElementById('puzzle-form');
            const keyInput = document.getElementById('key-input');
            const submitBtn = document.getElementById('submit-btn');
            const messageArea = document.getElementById('message-area');

            // 页面加载时执行的核心验证函数
            async function verifyUserAndProgress() {
                const username = getCookie('username');
                const password = getCookie('password');

                // 1. 检查Cookie是否存在
                if (!username || !password) {
                    window.location.href = '../index.html';
                    return; // 终止执行
                }
                
                // 存储用户名，供后续更新进度时使用
                currentUsername = username;

                try {
                    // 2. 调用API验证账户密码
                    const response = await fetch('/acc_check_password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password }),
                    });

                    // 如果响应状态码不是200 OK (例如401, 404)，说明验证失败，返回登录页
                    if (!response.ok) {
                        window.location.href = '../index.html';
                        return;
                    }

                    const data = await response.json();

                    // 如果API返回的success标志为false，也返回登录页
                    if (!data.success) {
                        window.location.href = '../index.html';
                        return;
                    }

                    // 3. 检查用户进度是否符合当前页面要求 (progress必须为'3')
                    if (data.user_data.progress !== '3') {
                        window.location.href = '../main.html';
                        return;
                    }

                    // 所有检查通过，隐藏加载动画
                    loaderWrapper.classList.add('hidden');

                } catch (error) {
                    console.error('Verification Error:', error);
                    loaderStatus.textContent = '验证失败，网络连接错误。';
                    // 网络错误时，2秒后也返回登录页
                    setTimeout(() => { window.location.href = '../index.html'; }, 2000);
                }
            }
            
            // 立即开始验证流程
            verifyUserAndProgress();
            
            // 谜题表单提交事件监听
            puzzleForm.addEventListener('submit', (event) => {
                event.preventDefault();
                
                const userKey = keyInput.value.trim().toLowerCase();
                if (!userKey) {
                    showMessage('请输入密钥。', 'error');
                    keyInput.classList.add('shake');
                    setTimeout(() => keyInput.classList.remove('shake'), 500);
                    return;
                }

                // 根据谜题提示，正确密钥是 "hexagon"
                const correctAnswer = 'hexagon';

                setFormDisabled(true, '验证中...');
                
                // 模拟网络延迟并检查答案
                setTimeout(() => {
                    if (userKey === correctAnswer) {
                        // 答案正确，调用成功处理函数
                        handleSuccess('密钥正确！正在更新您的进度...');
                    } else {
                        // 答案错误，调用失败处理函数
                        handleError('密钥错误。');
                    }
                }, 300);
            });
            
            function setFormDisabled(disabled, buttonText = '提 交') {
                keyInput.disabled = disabled;
                submitBtn.disabled = disabled;
                submitBtn.textContent = buttonText;
            }

            function showMessage(text, type) {
                messageArea.textContent = text;
                messageArea.className = 'message-area';
                if (type) {
                    messageArea.classList.add(type, 'visible');
                }
            }

            // 成功解谜后的处理函数
            async function handleSuccess(message) {
                showMessage(message, 'success');
                setFormDisabled(true, '已解锁');
                keyInput.style.borderColor = 'var(--success-text)';

                try {
                    // 新增步骤：调用API将进度更新为 "4"
                    const response = await fetch('/set_user_data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: currentUsername,
                            option: 'progress',
                            value: '4' 
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        showMessage('进度已成功更新！', 'success');
                        // 更新成功后，2秒后跳转回主流程页面
                        setTimeout(() => {
                            window.location.href = '../storyline/insight/node3.html';
                        }, 2000);
                    } else {
                        // 如果进度更新失败，向用户显示错误信息
                        handleError(`进度更新失败: ${data.message || '未知错误'}`);
                    }

                } catch (error) {
                    console.error('Progress Update Error:', error);
                    handleError('更新进度时发生网络错误，请稍后重试。');
                }
            }

            // 失败处理函数
            function handleError(message) {
                showMessage(message, 'error');
                keyInput.classList.add('shake');
                setTimeout(() => keyInput.classList.remove('shake'), 500);
                setFormDisabled(false); // 出错后允许用户重试
            }
        });
    </script>

</body>
</html>