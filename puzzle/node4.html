<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°œé¢˜4</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --glow-color: #00ffff;
            --secondary-glow-color: #7a00ff;
            --bg-color: #050810;
            --dark-core-bg: rgba(8, 12, 28, 0.85);
            --error-color: #ff4d4d;
            --success-color: #4dff88;
        }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background: var(--bg-color);
            font-family: 'Orbitron', sans-serif; color: #e0e6f0;
            display: flex; justify-content: center; align-items: center;
        }

        /* --- åŠ è½½åŠ¨ç”» --- */
        #loader-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
            transition: opacity 0.8s ease-out;
        }
        .loader-text {
            color: var(--glow-color); margin-bottom: 20px;
            font-size: 1.2em; letter-spacing: 2px;
        }
        #loader-status-text {
            color: #9ab; font-size: 0.9em; margin-top: 15px;
            min-height: 1.2em; transition: opacity 0.5s;
        }
        .loader {
            width: 80px; height: 80px; border: 3px solid transparent;
            border-top-color: var(--glow-color); border-radius: 50%;
            animation: spin 1.5s linear infinite;
        }
        #loader-wrapper.loaded { opacity: 0; pointer-events: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- åŠ¨æ€æ˜Ÿç©ºèƒŒæ™¯ --- */
        #stars, #stars2, #stars3 {
            position: absolute; top: 0; left: 0; width: 1px; height: 1px;
            background: transparent;
        }
        #stars { animation: animStar 50s linear infinite; }
        #stars2 { animation: animStar 100s linear infinite; }
        #stars3 { animation: animStar 150s linear infinite; }
        @keyframes animStar { from { transform: translateY(0px); } to { transform: translateY(-2000px); } }

        /* --- æ˜Ÿä½“ä»ªèƒŒæ™¯ --- */
        .orrery-background {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90vmin; height: 90vmin;
            min-width: 400px; min-height: 400px; max-width: 700px; max-height: 700px;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 1.5s ease-out 0.5s; /* Added delay */
            z-index: 1;
        }
        .orrery-background.visible { opacity: 0.7; }
        .ring {
            position: absolute; border-radius: 50%; border: 2px solid transparent;
            box-sizing: border-box; transition: animation-duration 0.5s ease-in-out;
        }
        .ring-1 { width: 100%; height: 100%; border-style: dotted; border-color: rgba(0, 255, 255, 0.3); animation: spin 30s linear infinite; }
        .ring-2 { width: 85%; height: 85%; border: 1px solid rgba(122, 0, 255, 0.4); border-left-color: var(--secondary-glow-color); border-right-color: var(--secondary-glow-color); animation: spin 45s linear infinite reverse; }
        .ring-3 { width: 70%; height: 70%; border-top: 2px solid var(--glow-color); border-bottom: 2px solid var(--glow-color); animation: spin 20s linear infinite; }
        
        /* --- è°œé¢˜ä¸»é¢æ¿ --- */
        .puzzle-panel {
            position: relative;
            width: clamp(360px, 80vw, 850px);
            max-height: 85vh;
            background: var(--dark-core-bg);
            border: 1px solid rgba(0, 255, 255, 0.2);
            box-shadow: inset 0 0 40px rgba(0, 255, 255, 0.1), 0 0 30px rgba(0, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: clamp(20px, 4vw, 40px);
            box-sizing: border-box;
            text-align: center;
            z-index: 10;
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 1.2s ease-out, transform 1.2s ease-out;
            overflow-y: auto;
        }

        .puzzle-panel.visible {
            opacity: 1;
            transform: scale(1);
        }

        /* --- é¢æ¿å†…å®¹æ ·å¼ --- */
        h1 { font-size: clamp(1.8rem, 5vmin, 2.5rem); color: var(--glow-color); margin: 0 0 15px; text-shadow: 0 0 10px var(--glow-color); }
        .flavor-text { 
            font-size: clamp(0.85rem, 2vmin, 1.0rem); 
            color: #c0c8e0; 
            margin-bottom: 25px; 
            line-height: 1.8;
            width: 100%;
            text-align: left; /* Aligned left for readability */
            white-space: pre-wrap; /* Preserves formatting like line breaks */
        }
        #key-form { 
            width: 90%; 
            max-width: 400px;
            display: flex; 
            flex-direction: column; 
            align-items: center;
            margin-top: 20px;
        }
        #key-input {
            width: 100%; background: transparent; border: none; border-bottom: 2px solid rgba(0, 255, 255, 0.4);
            color: #fff; font-size: clamp(1rem, 2.5vmin, 1.2rem); font-family: 'Orbitron', sans-serif;
            outline: none; text-align: center; padding: 10px 0; transition: all 0.3s ease;
        }
        #key-input::placeholder { color: rgba(255, 255, 255, 0.4); }
        #key-input:focus { border-bottom-color: var(--glow-color); text-shadow: 0 0 5px var(--glow-color); }
        #key-input.error-shake { animation: shake 0.5s ease-in-out; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); } 20%, 40%, 60%, 80% { transform: translateX(8px); }
        }

        #submit-button {
            background: transparent; border: 2px solid var(--glow-color); color: var(--glow-color);
            border-radius: 50%; width: 70px; height: 70px; margin-top: 25px;
            font-family: 'Orbitron', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer;
            transition: all 0.3s ease; position: relative; box-shadow: 0 0 10px var(--glow-color);
        }
        #submit-button:hover:not(:disabled) { background: var(--glow-color); color: var(--bg-color); box-shadow: 0 0 25px var(--glow-color), 0 0 40px var(--glow-color); transform: scale(1.05); }
        #submit-button:disabled { border-color: #555; color: #888; cursor: wait; box-shadow: none; }

        #message-area {
            margin-top: 20px; min-height: 20px; font-size: clamp(0.8rem, 2vmin, 1rem);
            font-weight: bold; opacity: 0; transition: opacity 0.3s ease;
        }
        #message-area.visible { opacity: 1; }
        #message-area.success { color: var(--success-color); text-shadow: 0 0 8px var(--success-color); }
        #message-area.error { color: var(--error-color); text-shadow: 0 0 8px var(--error-color); }
    </style>
</head>
<body>
    <div id="loader-wrapper">
        <div class="loader-text">loading...</div>
        <div class="loader"></div>
        <p id="loader-status-text"></p>
    </div>

    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>

    <div class="orrery-background" id="orrery-container">
        <div class="ring ring-1"></div>
        <div class="ring ring-2"></div>
        <div class="ring ring-3"></div>
    </div>
    
    <div class="puzzle-panel" id="puzzle-panel">
        <h1>è§£è°œ4</h1>
        <p class="flavor-text">
SCP-â–ˆâ–ˆâ–ˆé”€æ¯è®°å½•

Dçº§äººå‘˜-â–ˆâ–ˆâ–ˆâ–ˆè¢«æŒ‡æŒ¥æ‹¿å–SCP-â–ˆâ–ˆâ–ˆ

è¿›å…¥siteåï¼Œå‡‰æ„è¢­æ¥ï¼Œè®¾æ–½å†…å¹¶æœªé€šç”µï¼Œåœ¨æš—æ·¡çš„æœˆå…‰ç…§å°„ä¸‹çš„siteä¸­ï¼ŒDçº§äººå‘˜çœ‹æ¸…äº†SCP-â–ˆâ–ˆâ–ˆ çš„å…¨è²Œã€‚

ä¼¼ä¹æ—¶éšæ—¶ç°çš„é—ªçƒç€TOO LATE TO DIE YOUNGï¼ˆæ—©æ­»æ—©è¶…ç”Ÿï¼‰

â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆåšå£«åœ¨èƒŒåè®°å½•è¿™æ¬¡çš„å®éªŒã€‚

çªç„¶ç´§æ€¥è­¦æŠ¥è¢«å¯åŠ¨ã€‚

MTFä»‹å…¥ã€‚

ä¸­æ–­ã€‚

U1AwOG90aW1uQmVjQy03Q25hbmV0cmFo

å…³äºDçº§äººå‘˜-â–ˆâ–ˆâ–ˆâ–ˆåŠâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆåšå£«çš„å¤„å†³

å› Dçº§äººå‘˜-â–ˆâ–ˆâ–ˆâ–ˆå’Œâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆåšå£«åœ¨SCP-â–ˆâ–ˆâ–ˆä¸­æš´éœ²å¤šæ—¶ï¼Œç›®å‰å·²è®¤ä¸ºäºŒäººå¤„äºD-19384ä¸­è®°è½½çš„â€œæœ€åâ€é˜¶æ®µï¼Œæ•…æ‰§è¡Œå¤„å†³ç¨‹åºã€‚

å¤šæ•°ç¥¨å†³è®®è®ºæ‰“å¼€äº†å¦ä¸€ä¸ªä¸–ç•Œçš„å¤§é—¨ï¼ˆbackroomsï¼‰ã€‚å¹¶æ´¾é£ä¸€æ”¯MTFç¡®ä¿å¤„å†³ä»»åŠ¡çš„é¡ºåˆ©æ‰§è¡Œã€‚

c21ubWVhZXVicg==

æ¥åˆ°level-â–ˆâ–ˆï¼Œé€è¿‡èˆ·çª—çœ‹åˆ°å¤–é¢çš„é£æ™¯ã€‚

æœ‰ä¸€æ‰‡èˆ·çª—æ ¼å¤–å¼‚å¸¸ï¼Œæƒ³å¿…è¿™å°±æ˜¯è¦å»çš„åœ°æ–¹äº†ã€‚

å¤„å†³ç»“æœ

åœ¨å°†ä¸¤ä½äººå‘˜é€šè¿‡å¼‚å¸¸çš„èˆ·çª—é€å…¥åã€‚é¡ºåˆ©å®Œæˆç›®æ ‡ã€‚

è€Œèˆ·çª—å¤–çš„ä¸–ç•Œï¼Œå³æ˜¯ç»ˆç‚¹ã€‚

å¤„å†³é¡ºåˆ©å®Œæˆã€‚

å¤„å†³ç³»æ•°(å¯åº”ç”¨äºå…¨ç¨‹):
æ”¶å®¹å¯¹è±¡:ç™¾åˆå’²
å¯¹è±¡ç§»åŠ¨é€Ÿåº¦:160 m/s
ç¼–å·:Number of "T"

è¾“å…¥å¯†é’¥ï¼š____

ï¼ˆå¦‚æœä½ å¹¶ä¸èƒ½é€šè¿‡ä»¥ä¸Šè§£å‡ºè°œé¢˜çš„è¯ï¼Œè¿™ä¸‹é¢è¿˜æœ‰ä¸€ä¸ªç‰¹è°œï¼Œç›´é€šç»ˆç‚¹dogeï¼‰

â…¿ğŸšØŒğ—€â‰ºâ³ğ‘¿ï¼â„¤ğ—€ï¼ğ‘’ğ–¯ğŸ©ğŸ 

ï¼ˆæç¤ºï¼šå›å½’åˆå§‹ï¼‰
        </p>
        <form id="key-form" onsubmit="return false;">
            <input type="text" id="key-input" name="key" placeholder="åœ¨æ­¤è¾“å…¥" autocomplete="off" required>
            <button type="submit" id="submit-button">æäº¤</button>
        </form>
        <div id="message-area"></div>
    </div>
    

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE_URL = 'http://abyssal4.asterveil.top/api';

            // --- Element Cache ---
            const elements = {
                loaderWrapper: document.getElementById('loader-wrapper'),
                loaderStatusText: document.getElementById('loader-status-text'),
                orreryContainer: document.getElementById('orrery-container'),
                puzzlePanel: document.getElementById('puzzle-panel'), // New reference
                form: document.getElementById('key-form'),
                keyInput: document.getElementById('key-input'),
                submitButton: document.getElementById('submit-button'),
                messageArea: document.getElementById('message-area'),
                orreryRings: document.querySelectorAll('.ring')
            };

            // --- Helper Functions ---
            const getCookie = (name) => {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            };

            const setLoaderStatus = (text) => {
                elements.loaderStatusText.textContent = text;
            };

            const showMessage = (text, type = 'error') => {
                elements.messageArea.textContent = text;
                elements.messageArea.className = 'visible';
                elements.messageArea.classList.add(type);
                elements.keyInput.classList.remove('error-shake');
                if (type === 'error') {
                    setTimeout(() => elements.keyInput.classList.add('error-shake'), 0);
                }
            };
            
            const setRingsState = (state) => {
                // Adjust animation speed of background rings
                elements.orreryRings.forEach(ring => {
                    const baseDuration = parseInt(ring.style.animation.split(' ')[1] || '30');
                    ring.style.animationDuration = state === 'validating' ? '5s' : `${baseDuration}s`;
                });
            };

            const generateStarLayer = (id, count) => {
                const element = document.getElementById(id);
                if (!element) return;
                let boxShadow = '';
                for (let i = 0; i < count; i++) {
                    boxShadow += `${Math.floor(Math.random() * 2000)}px ${Math.floor(Math.random() * 2000)}px #FFF, `;
                }
                element.style.boxShadow = boxShadow.slice(0, -2);
            };

            // --- Main Logic ---

            async function initializePage() {
                generateStarLayer('stars', 700);
                generateStarLayer('stars2', 200);
                generateStarLayer('stars3', 100);

                const username = getCookie('username');
                const password = getCookie('password');

                if (!username || !password) {
                    setLoaderStatus("æœªæ‰¾åˆ°èº«ä»½å‡­è¯ï¼Œæ­£åœ¨è¿”å›...");
                    setTimeout(() => window.location.href = '../index.html', 1500);
                    return;
                }

                setLoaderStatus("æ­£åœ¨åˆ¤æ–­è´¦æˆ·è¿›åº¦...");
                try {
                    const response = await fetch(`${API_BASE_URL}/acc_check_password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });

                    if (!response.ok) {
                        throw new Error('è´¦æˆ·éªŒè¯å¤±è´¥');
                    }
                    
                    const data = await response.json();
                    const progress = data.user_data.progress;

                    setLoaderStatus("è¿›åº¦æ ¡éªŒ...");

                    if (progress === "4") {
                        setLoaderStatus("æ ¡éªŒé€šè¿‡ï¼ŒåŠ è½½è°œé¢˜...");
                        setTimeout(() => {
                            elements.loaderWrapper.classList.add('loaded');
                            elements.orreryContainer.classList.add('visible');
                            elements.puzzlePanel.classList.add('visible'); // Show the new panel
                        }, 1000);
                    } else if (progress === "5") {
                        setLoaderStatus("è¿›åº¦å·²å®Œæˆï¼Œæ­£åœ¨è·³è½¬...");
                        setTimeout(() => window.location.href = '../storyline/insight/node4.html', 1500);
                    } else {
                        setLoaderStatus("è¿›åº¦ä¸åŒ¹é…ï¼Œæ­£åœ¨è¿”å›ä¸»é¡µ...");
                        setTimeout(() => window.location.href = '../main.html', 1500);
                    }
                } catch (error) {
                    console.error('Initialization Error:', error);
                    setLoaderStatus(error.message + "ï¼Œæ­£åœ¨è¿”å›ç™»å½•é¡µ...");
                    setTimeout(() => window.location.href = '../index.html', 2000);
                }
            }

            elements.form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const key = elements.keyInput.value.trim();
                if (!key) {
                    showMessage('åºåˆ—ä¸èƒ½ä¸ºç©ºï¼', 'error');
                    return;
                }

                elements.submitButton.disabled = true;
                elements.submitButton.textContent = '...';
                elements.keyInput.disabled = true;
                elements.messageArea.className = ''; // Hide previous message
                setRingsState('validating');

                try {
                    const checkKeyResponse = await fetch(`${API_BASE_URL}/check-key`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ nodeId: "node4", key: key })
                    });
                    
                    const keyData = await checkKeyResponse.json();

                    if (checkKeyResponse.ok && keyData.success) {
                        if (!keyData.metaStarted && keyData.remainingSeconds === undefined) {
                            showMessage("åºåˆ—æ­£ç¡®ï¼æ­£åœ¨ä¿å­˜è¿›åº¦...", 'success');
                            
                            const username = getCookie('username');
                            try {
                                const setProgressResponse = await fetch(`${API_BASE_URL}/set_user_data`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ username: username, option: "progress", value: "5" })
                                });
                                if (!setProgressResponse.ok) throw new Error('è¿›åº¦ä¿å­˜å¤±è´¥');
                                
                                console.log('Progress updated successfully.');
                                setTimeout(() => {
                                    window.location.href = '../storyline/insight/node4.html';
                                }, 1500);

                            } catch (updateError) {
                                console.error('Progress Update Error:', updateError);
                                showMessage("åºåˆ—æ­£ç¡®ï¼Œä½†ä¿å­˜è¿›åº¦å¤±è´¥ï¼è¯·è”ç³»ç®¡ç†å‘˜ã€‚ä»å°†ä¸ºæ‚¨è·³è½¬...", 'error');
                                setTimeout(() => {
                                    window.location.href = '../storyline/insight/node4.html';
                                }, 2500);
                            }
                        } else {
                            showMessage(keyData.message, 'success');
                            resetForm();
                        }
                    } else {
                        let errorMessage = keyData.message || "æœªçŸ¥é”™è¯¯";
                        if (keyData.cooldown) errorMessage += ` å†·å´: ${keyData.cooldown}s`;
                        showMessage(errorMessage, 'error');
                        resetForm();
                    }
                } catch (error) {
                    console.error('Puzzle Submission Error:', error);
                    showMessage('è¿æ¥æ˜Ÿä½“ä»ªå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚', 'error');
                    resetForm();
                }
            });

            function resetForm() {
                setTimeout(() => {
                    elements.submitButton.disabled = false;
                    elements.submitButton.textContent = 'æäº¤';
                    elements.keyInput.disabled = false;
                    setRingsState('idle');
                }, 1000);
            }

            initializePage();
        });
    </script>
</body>
</html>